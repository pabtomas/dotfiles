name: ${SPACEPORN_ID}
services:
  ${RELAY_SERVICE}:
    build:
      context: ${CWD_PATH}/${RELAY_ID}
      dockerfile: Dockerfile
      args:
        ENTRYPOINTD_PATH: ${ENTRYPOINTD_PATH}
        HTTP_PROXY: ${http_proxy:-${HTTP_PROXY:-null}}
        HTTPS_PROXY: ${https_proxy:-${HTTPS_PROXY:-null}}
        LOG_ID: ${SPACEPORN_ID}
        SOCAT_COMPONENT_IMG: ${SOCAT_COMPONENT_IMG}
        TMP_XSERVER_SOCKETS_PATH: ${TMP_XSERVER_SOCKETS_PATH}
        XSERVER_IP: ${XSERVER_IP}
        XSERVER_PORT: "\"${XSERVER_PORT}\""
    container_name: ${SPACEPORN_RELAY_HOST}
    hostname: ${SPACEPORN_RELAY_HOST}
    image: ${RELAY_IMG}
    networks:
      ${PROXIFIED_XSERVER_SOCKET_NET}:
        ipv4_address: ${SPACEPORN_RELAY_IP}
    read_only: true
    volumes:
      - type: volume
        source: ${RELAY_XSERVER_SOCKET_VOLUME}
        target: ${TMP_XSERVER_SOCKETS_PATH}
        volume: {}
      - type: volume
        source: ${RELAY_VAR_LOG_VOLUME}
        target: ${VAR_LOG_PATH}
        volume: {}
  ${RUNNER_SERVICE}:
    build:
      context: ${RUNNERS_PATH}/${SPACEPORN_ID}
      dockerfile: Dockerfile
    container_name: ${SPACEPORN_RUNNER_HOST}
    depends_on:
      ${RELAY_SERVICE}:
        condition: service_started
        required: true
    deploy:
      resources:
        reservations:
          devices:
            - capabilities:
                - gpu
              count: -1
    hostname: ${SPACEPORN_RUNNER_HOST}
    image: ${SPACEPORN_RUNNER_IMG}
    networks:
      ${SPACEPORN_ID}_net: null
    volumes:
      - type: volume
        source: ${RELAY_XSERVER_SOCKET_VOLUME}
        target: ${TMP_XSERVER_SOCKETS_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${SPACEPORN_VOLUME}
        target: ${SPACEPORN_PATH}
        read_only: true
        volume: {}
networks:
  ${PROXIFIED_XSERVER_SOCKET_NET}:
    name: ${PROXIFIED_XSERVER_SOCKET_NET}
    external: true
  ${SPACEPORN_ID}_net:
    name: ${SPACEPORN_ID}_net
volumes:
  ${RELAY_VAR_LOG_VOLUME}:
    name: ${RELAY_VAR_LOG_VOLUME}
    external: true
  ${RELAY_XSERVER_SOCKET_VOLUME}:
    name: ${RELAY_XSERVER_SOCKET_VOLUME}
  ${SPACEPORN_VOLUME}:
    name: ${SPACEPORN_VOLUME}
    external: true
