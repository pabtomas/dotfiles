name: ${COMPOSE_PROJECT_NAME}
services:
  ${BUILDER_SERVICE}:
    build:
      context: ${CWD_PATH}/${BUILDER_ID}
      dockerfile: Dockerfile
      args:
        _BUILDKIT_LOCAL_IMG: ${_BUILDKIT_LOCAL_IMG}
        BUILDER_PORT: "\"${BUILDER_PORT}\""
    command:
      - --addr
      - tcp://0.0.0.0:${BUILDER_PORT}
      - --oci-worker-no-process-sandbox
    container_name: ${BUILDER_HOST}
    hostname: ${BUILDER_HOST}
    image: ${BUILDER_IMG}
    networks:
      ${BUILDER_NET}: null
    security_opt:
      - apparmor:unconfined
      - seccomp:unconfined
  ${CONTROLLER_SERVICE}:
    container_name: ${CONTROLLER_HOST}
    depends_on:
      ${BUILDER_SERVICE}:
        condition: service_started
        required: true
      ${LISTENER_SERVICE}:
        condition: service_started
        required: true
      ${PROXY_SERVICE}:
        condition: service_started
        required: true
      ${REGISTRY_SERVICE}:
        condition: service_started
        required: true
      ${XSERVER_SERVICE}:
        condition: service_started
        required: true
    hostname: ${CONTROLLER_HOST}
    image: ${_DOCKER_COMPONENT_IMG}
    networks:
      ${BUILDER_NET}: null
      ${JUMP_AREA_NET}: null
      ${PROXIFIED_DOCKER_SOCKET_NET}:
        ipv4_address: ${CONTROLLER_IP}
      ${REGISTRY_NET}: null
    volumes:
      - type: volume
        source: ${SSH_VOLUME}
        target: ${SSH_ROOT_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${MYWHALEFLEET_VOLUME}
        target: ${MYWHALEFLEET_PATH}
        volume: {}
      - type: volume
        source: ${THEME_VOLUME}
        target: ${BASH_THEME_PATH}
        read_only: true
        volume: {}
  ${EDITOR_SERVICE}:
    container_name: ${EDITOR_HOST}
    depends_on:
      ${LISTENER_SERVICE}:
        condition: service_started
        required: true
    hostname: ${EDITOR_HOST}
    image: ${VIM_COMPONENT_IMG}
    networks:
      ${JUMP_AREA_NET}: null
    volumes:
      - type: volume
        source: ${SSH_VOLUME}
        target: ${SSH_ROOT_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${MYWHALEFLEET_VOLUME}
        target: ${MYWHALEFLEET_PATH}
        volume: {}
      - type: volume
        source: ${SPACEPORN_VOLUME}
        target: ${SPACEPORN_PATH}
        volume: {}
      - type: volume
        source: ${THEME_VOLUME}
        target: ${BASH_THEME_PATH}
        read_only: true
        volume: {}
  ${SHELL_EXPLORER_SERVICE}:
    container_name: ${SHELL_EXPLORER_HOST}
    depends_on:
      ${LISTENER_SERVICE}:
        condition: service_started
        required: true
    hostname: ${SHELL_EXPLORER_HOST}
    image: ${SHELL_COMPONENT_IMG}
    networks:
      ${JUMP_AREA_NET}: null
    volumes:
      - type: volume
        source: ${SSH_VOLUME}
        target: ${SSH_ROOT_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${MYWHALEFLEET_VOLUME}
        target: ${MYWHALEFLEET_PATH}
        volume: {}
      - type: volume
        source: ${THEME_VOLUME}
        target: ${BASH_THEME_PATH}
        read_only: true
        volume: {}
  ${ZIG_EXPLORER_SERVICE}:
    container_name: ${ZIG_EXPLORER_HOST}
    depends_on:
      ${LISTENER_SERVICE}:
        condition: service_started
        required: true
    hostname: ${ZIG_EXPLORER_HOST}
    image: ${ZIG_COMPONENT_IMG}
    networks:
      ${JUMP_AREA_NET}: null
    volumes:
      - type: volume
        source: ${SSH_VOLUME}
        target: ${SSH_ROOT_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${SPACEPORN_VOLUME}
        target: ${SPACEPORN_PATH}
        volume: {}
      - type: volume
        source: ${THEME_VOLUME}
        target: ${BASH_THEME_PATH}
        read_only: true
        volume: {}
  ${JUMPER_SERVICE}:
    build:
      context: ${CWD_PATH}/${JUMPER_ID}
      dockerfile: Dockerfile
      args:
        BASH_COMPLETION_PATH: ${BASH_COMPLETION_PATH}
        BASH_THEME_PATH: ${BASH_THEME_PATH}
        COMPLETION_PATH: /opt/${LISTENER_ID}${COMPLETION_PATH}
        CONTROLLER_ID: ${CONTROLLER_ID}
        ENTRYPOINTD_PATH: ${ENTRYPOINTD_PATH}
        HOSTNAME: ${JUMPER_ID}
        HTTP_PROXY: ${http_proxy:-${HTTP_PROXY:-null}}
        HTTPS_PROXY: ${https_proxy:-${HTTPS_PROXY:-null}}
        NET_PFX: ${JUMP_AREA_PFX}
        OPT_SCRIPTS_PATH: ${OPT_SCRIPTS_PATH}
        OPT_SSH_PATH: ${OPT_SSH_PATH}
        SSH_ROOT_PATH: ${SSH_ROOT_PATH}
        TCP_DOCKER_HOST: ${TCP_DOCKER_HOST}
        TMUX_COMPONENT_IMG: ${TMUX_COMPONENT_IMG}
    container_name: ${JUMPER_HOST}
    depends_on:
      ${LISTENER_SERVICE}:
        condition: service_started
        required: true
    hostname: ${JUMPER_HOST}
    image: ${JUMPER_IMG}
    networks:
      ${JUMP_AREA_NET}: null
    stdin_open: true
    tty: true
    volumes:
      - type: volume
        source: ${SSH_VOLUME}
        target: ${OPT_SSH_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${PROXY_ETC_NGINX_VOLUME}
        target: /opt/${PROXY_ID}${ETC_NGINX_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${PROXY_OPT_SCRIPTS_VOLUME}
        target: /opt/${PROXY_ID}${OPT_SCRIPTS_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${PROXY_VAR_LOG_NGINX_VOLUME}
        target: /opt/${PROXY_ID}${VAR_LOG_NGINX_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${LISTENER_OPT_DATA_VOLUME}
        target: /opt/${LISTENER_ID}${DATA_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${LISTENER_OPT_SCRIPTS_VOLUME}
        target: /opt/${LISTENER_ID}${OPT_SCRIPTS_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${RELAY_VAR_LOG_VOLUME}
        target: /opt/${RELAY_ID}${VAR_LOG_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${XSERVER_ETC_NGINX_VOLUME}
        target: /opt/${XSERVER_ID}${ETC_NGINX_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${XSERVER_OPT_SCRIPTS_VOLUME}
        target: /opt/${XSERVER_ID}${OPT_SCRIPTS_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${XSERVER_VAR_LOG_NGINX_VOLUME}
        target: /opt/${XSERVER_ID}${VAR_LOG_NGINX_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${THEME_VOLUME}
        target: ${BASH_THEME_PATH}
        volume: {}
  ${LISTENER_SERVICE}:
    build:
      context: ${CWD_PATH}/${LISTENER_ID}
      dockerfile: Dockerfile
      args:
        APK_PATHS: ${APK_PATHS}
        COMPLETION_PATH: ${COMPLETION_PATH}
        DATA_PATH: ${DATA_PATH}
        ENTRYPOINT_COMPONENT_IMG: ${ENTRYPOINT_COMPONENT_IMG}
        ENTRYPOINTD_PATH: ${ENTRYPOINTD_PATH}
        HTTP_DOCKER_HOST: ${HTTP_DOCKER_HOST}
        HTTP_PROXY: ${http_proxy:-${HTTP_PROXY:-null}}
        HTTPS_PROXY: ${https_proxy:-${HTTPS_PROXY:-null}}
        NET: ${JUMP_AREA_NET}
    container_name: ${LISTENER_HOST}
    depends_on:
      ${PROXY_SERVICE}:
        condition: service_started
        required: true
    hostname: ${LISTENER_HOST}
    image: ${LISTENER_IMG}
    networks:
      ${PROXIFIED_DOCKER_SOCKET_NET}:
        ipv4_address: ${LISTENER_IP}
    read_only: true
    volumes:
      - type: volume
        source: ${LISTENER_OPT_DATA_VOLUME}
        target: ${DATA_PATH}
        volume: {}
      - type: volume
        source: ${LISTENER_OPT_SCRIPTS_VOLUME}
        target: ${OPT_SCRIPTS_PATH}
        read_only: true
        volume: {}
  ${PROXY_SERVICE}:
    build:
      context: ${CWD_PATH}/${PROXY_ID}
      dockerfile: Dockerfile
      args:
        ${API_PFX}_PING: "\"${TRUE}\""
        ${API_PFX}BUILD: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_CREATE: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_ARCHIVE: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_ATTACH: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_EXEC: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_JSON: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_LOGS: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_KILL: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_START: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_STOP: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_ID_WAIT: "\"${TRUE}\""
        ${API_PFX}CONTAINERS_JSON: "\"${TRUE}\""
        ${API_PFX}EVENTS: "\"${TRUE}\""
        ${API_PFX}IMAGES_CREATE: "\"${TRUE}\""
        ${API_PFX}IMAGES_JSON: "\"${TRUE}\""
        ${API_PFX}IMAGES_NAME: "\"${TRUE}\""
        ${API_PFX}NETWORKS: "\"${TRUE}\""
        ${API_PFX}VERSION: "\"${TRUE}\""
        ${API_PFX}VOLUMES: "\"${TRUE}\""
        API_PFX: ${API_PFX}
        API_TAG: "\"${API_TAG}\""
        API_URL: ${API_URL}
        APK_PATHS: ${APK_PATHS}
        LISTENER_IP: ${LISTENER_IP}
        CONTROLLER_IP: ${CONTROLLER_IP}
        _DOCKER_SOCKET_PATH: ${_DOCKER_SOCKET_PATH}
        ENTRYPOINTD_PATH: ${ENTRYPOINTD_PATH}
        ETC_NGINX_HTTPD_PATH: ${ETC_NGINX_HTTPD_PATH}
        HTTP_COMPONENT_IMG: ${HTTP_COMPONENT_IMG}
        HTTP_PROXY: ${http_proxy:-${HTTP_PROXY:-null}}
        HTTPS_PROXY: ${https_proxy:-${HTTPS_PROXY:-null}}
        OPT_SCRIPTS_PATH: ${OPT_SCRIPTS_PATH}
        PROXY_PORT: "\"${PROXY_PORT}\""
    container_name: ${PROXY_HOST}
    hostname: ${PROXY_HOST}
    image: ${PROXY_IMG}
    networks:
      ${PROXIFIED_DOCKER_SOCKET_NET}:
        ipv4_address: ${PROXY_IP}
    read_only: true
    tmpfs:
      - /run
      - /tmp
    volumes:
      - type: bind
        source: ${_DOCKER_SOCKET_PATH}
        target: ${_DOCKER_SOCKET_PATH}
        read_only: true
        bind: {}
      - type: volume
        source: ${PROXY_ETC_NGINX_VOLUME}
        target: ${ETC_NGINX_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${PROXY_OPT_SCRIPTS_VOLUME}
        target: ${OPT_SCRIPTS_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${PROXY_VAR_LOG_NGINX_VOLUME}
        target: ${VAR_LOG_NGINX_PATH}
        volume: {}
  ${REGISTRY_SERVICE}:
    container_name: ${REGISTRY_HOST}
    environment:
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: ${REGISTRY_STORAGE_PATH}
    hostname: ${REGISTRY_HOST}
    image: ${REGISTRY_IMG}
    networks:
      ${REGISTRY_NET}: null
    read_only: true
    volumes:
      - type: volume
        source: ${REGISTRY_VOLUME}
        target: ${REGISTRY_STORAGE_PATH}
        volume: {}
  ${SAFEDEPOSIT_SERVICE}:
    container_name: ${SAFEDEPOSIT_HOST}
    depends_on:
      ${LISTENER_SERVICE}:
        condition: service_started
        required: true
    hostname: ${SAFEDEPOSIT_HOST}
    image: ${PASS_COMPONENT_IMG}
    networks:
      ${JUMP_AREA_NET}: null
    volumes:
      - type: volume
        source: ${SSH_VOLUME}
        target: ${SSH_ROOT_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${SAFEDEPOSIT_VOLUME}
        target: ${SAFEDEPOSIT_PATH}
        volume: {}
      - type: volume
        source: ${THEME_VOLUME}
        target: ${BASH_THEME_PATH}
        read_only: true
        volume: {}
  ${SCHOLAR_SERVICE}:
    container_name: ${SCHOLAR_HOST}
    depends_on:
      ${LISTENER_SERVICE}:
        condition: service_started
        required: true
    hostname: ${SCHOLAR_HOST}
    image: ${MAN_COMPONENT_IMG}
    networks:
      ${JUMP_AREA_NET}: null
    volumes:
      - type: volume
        source: ${SSH_VOLUME}
        target: ${SSH_ROOT_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${THEME_VOLUME}
        target: ${BASH_THEME_PATH}
        read_only: true
        volume: {}
  ${XSERVER_SERVICE}:
    build:
      context: ${CWD_PATH}/${XSERVER_ID}
      dockerfile: Dockerfile
      args:
        APK_PATHS: ${APK_PATHS}
        ETC_NGINX_CONFD_PATH: ${ETC_NGINX_CONFD_PATH}
        ETC_NGINX_PATH: ${ETC_NGINX_PATH}
        HTTP_PROXY: ${http_proxy:-${HTTP_PROXY:-null}}
        HTTPS_PROXY: ${https_proxy:-${HTTPS_PROXY:-null}}
        NGINX_COMPONENT_IMG: ${NGINX_COMPONENT_IMG}
        SPACEPORN_RELAY_IP: ${SPACEPORN_RELAY_IP}
        VAR_LOG_NGINX_PATH: ${VAR_LOG_NGINX_PATH}
        XSERVER_PORT: "\"${XSERVER_PORT}\""
        XSERVER_SOCKET_PATH: ${XSERVER_SOCKET_PATH}
    container_name: ${XSERVER_HOST}
    hostname: ${XSERVER_HOST}
    image: ${XSERVER_IMG}
    networks:
      ${PROXIFIED_XSERVER_SOCKET_NET}:
        ipv4_address: ${XSERVER_IP}
    read_only: true
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /run
    volumes:
      - type: bind
        source: ${XSERVER_SOCKET_PATH}
        target: ${XSERVER_SOCKET_PATH}
        read_only: true
        bind: {}
      - type: volume
        source: ${XSERVER_ETC_NGINX_VOLUME}
        target: ${ETC_NGINX_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${XSERVER_OPT_SCRIPTS_VOLUME}
        target: ${OPT_SCRIPTS_PATH}
        read_only: true
        volume: {}
      - type: volume
        source: ${XSERVER_VAR_LOG_NGINX_VOLUME}
        target: ${VAR_LOG_NGINX_PATH}
        volume: {}
networks:
  ${BUILDER_NET}:
    name: ${BUILDER_NET}
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${BUILDER_SUB}
          gateway: ${BUILDER_GATEWAY_IP}
          ip_range: ${BUILDER_SUB}
  ${JUMP_AREA_NET}:
    name: ${JUMP_AREA_NET}
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${JUMP_AREA_SUB}
          gateway: ${JUMP_AREA_GATEWAY_IP}
          ip_range: ${JUMP_AREA_SUB}
  ${PROXIFIED_DOCKER_SOCKET_NET}:
    name: ${PROXIFIED_DOCKER_SOCKET_NET}
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${PROXIFIED_DOCKER_SOCKET_SUB}
          gateway: ${PROXIFIED_DOCKER_SOCKET_GATEWAY_IP}
          ip_range: ${PROXIFIED_DOCKER_SOCKET_SUB}
  ${PROXIFIED_XSERVER_SOCKET_NET}:
    name: ${PROXIFIED_XSERVER_SOCKET_NET}
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${PROXIFIED_XSERVER_SOCKET_SUB}
          gateway: ${PROXIFIED_XSERVER_SOCKET_GATEWAY_IP}
          ip_range: ${PROXIFIED_XSERVER_SOCKET_SUB}
  ${REGISTRY_NET}:
    name: ${REGISTRY_NET}
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${REGISTRY_SUB}
          gateway: ${REGISTRY_GATEWAY_IP}
          ip_range: ${REGISTRY_SUB}
volumes:
  ${LISTENER_OPT_DATA_VOLUME}:
    name: ${LISTENER_OPT_DATA_VOLUME}
  ${LISTENER_OPT_SCRIPTS_VOLUME}:
    name: ${LISTENER_OPT_SCRIPTS_VOLUME}
  ${MYWHALEFLEET_VOLUME}:
    name: ${MYWHALEFLEET_VOLUME}
  ${PROXY_ETC_NGINX_VOLUME}:
    name: ${PROXY_ETC_NGINX_VOLUME}
  ${PROXY_OPT_SCRIPTS_VOLUME}:
    name: ${PROXY_OPT_SCRIPTS_VOLUME}
  ${PROXY_VAR_LOG_NGINX_VOLUME}:
    name: ${PROXY_VAR_LOG_NGINX_VOLUME}
  ${REGISTRY_VOLUME}:
    name: ${REGISTRY_VOLUME}
  ${RELAY_VAR_LOG_VOLUME}:
    name: ${RELAY_VAR_LOG_VOLUME}
  ${SAFEDEPOSIT_VOLUME}:
    name: ${SAFEDEPOSIT_VOLUME}
  ${SSH_VOLUME}:
    name: ${SSH_VOLUME}
  ${SPACEPORN_VOLUME}:
    name: ${SPACEPORN_VOLUME}
  ${THEME_VOLUME}:
    name: ${THEME_VOLUME}
  ${XSERVER_ETC_NGINX_VOLUME}:
    name: ${XSERVER_ETC_NGINX_VOLUME}
  ${XSERVER_OPT_SCRIPTS_VOLUME}:
    name: ${XSERVER_OPT_SCRIPTS_VOLUME}
  ${XSERVER_VAR_LOG_NGINX_VOLUME}:
    name: ${XSERVER_VAR_LOG_NGINX_VOLUME}
