---

# TODO:
# - variabilize ids
# - variabilize depends_on
# - use JQ filter instead of Golang template

rule:
  id: '{{ $rules.up }}'
  run:
    - requests:
        endpoint: /images/json
        method: GET
        with:
          - body:
              id: get.local.alpine.image
              query:
                filters: '{"reference":{"{{ $alpine.image.source }}":true}}'
              register: localalpineimage
    - processor:
        id: process.conditional.local.alpine.image
        as: not_local_alpine_image
        data: '{{ localalpineimage }}'
        filter: '{{ ne 1 (len $localalpineimage) }}'
        depends_on:
          - get.local.alpine.image
    - requests:
        if: '{{ not_local_alpine_image }}'
        endpoint: /images/create
        method: POST
        depends_on:
          - process.conditional.local.alpine.image
        with:
          - body:
              id: '{{ $dependencies.images.pull.alpine }}'
              query:
                fromImage: '{{ $alpine.image.source }}'
                tag: '{{ $alpine.tag }}'
    - requests:
        endpoint: /images/json
        method: GET
        with:
          - body:
              id: get.local.bash.image
              query:
                filters: '{"reference":{"{{ $bash.image.source }}":true}}'
              register: localbashimage
    - processor:
        id: process.conditional.local.bash.image
        as: not_local_bash_image
        data: '{{ localbashimage }}'
        filter: '{{ ne 1 (len $localbashimage) }}'
        depends_on:
          - get.local.bash.image
    - requests:
        if: '{{ not_local_bash_image }}'
        endpoint: /images/create
        method: POST
        depends_on:
          - process.conditional.local.bash.image
        with:
          - body:
              id: '{{ $dependencies.images.pull.bash }}'
              query:
                fromImage: '{{ $bash.image.source }}'
                tag: '{{ $bash.tag }}'
    - requests:
        endpoint: /images/json
        method: GET
        with:
          - body:
              id: get.local.buildkit.image
              query:
                filters: '{"reference":{"{{ $buildkit.image.source }}":true}}'
              register: localbuildkitimage
    - processor:
        id: process.conditional.local.buildkit.image
        as: not_local_buildkit_image
        data: '{{ localbuildkitimage }}'
        filter: '{{ ne 1 (len $localbuildkitimage) }}'
        depends_on:
          - get.local.buildkit.image
    - requests:
        if: '{{ not_local_buildkit_image }}'
        endpoint: /images/create
        method: POST
        depends_on:
          - process.conditional.local.buildkit.image
        with:
          - body:
              id: '{{ $dependencies.images.pull.buildkit }}'
              query:
                fromImage: '{{ $buildkit.image.source }}'
                tag: '{{ $buildkit.tag }}'
    - requests:
        endpoint: /images/json
        method: GET
        with:
          - body:
              id: get.local.docker.image
              query:
                filters: '{"reference":{"{{ $docker.image.source }}":true}}'
              register: localdockerimage
    - processor:
        id: process.conditional.local.docker.image
        as: not_local_docker_image
        data: '{{ localdockerimage }}'
        filter: '{{ ne 1 (len $localdockerimage) }}'
        depends_on:
          - get.local.docker.image
    - requests:
        if: '{{ not_local_docker_image }}'
        endpoint: /images/create
        method: POST
        depends_on:
          - process.conditional.local.docker.image
        with:
          - body:
              id: '{{ $dependencies.images.pull.docker }}'
              query:
                fromImage: '{{ $docker.image.source }}'
                tag: '{{ $docker.tag }}'
    - requests:
        endpoint: /images/json
        method: GET
        with:
          - body:
              id: get.local.registry.image
              query:
                filters: '{"reference":{"{{ $registry.image.source }}":true}}'
              register: localregistryimage
    - processor:
        id: process.conditional.local.registry.image
        as: not_local_registry_image
        data: '{{ localregistryimage }}'
        filter: '{{ ne 1 (len $localregistryimage) }}'
        depends_on:
          - get.local.registry.image
    - requests:
        if: '{{ not_local_registry_image }}'
        endpoint: /images/create
        method: POST
        depends_on:
          - process.conditional.local.registry.image
        with:
          - body:
              id: '{{ $dependencies.images.pull.registry }}'
              query:
                fromImage: '{{ $registry.image.source }}'
                tag: '{{ $registry.tag }}'
    - requests:
        endpoint: /images/json
        method: GET
        with:
          - body:
              id: get.local.socketproxy.image
              query:
                filters: '{"reference":{"{{ $socketproxy.linuxserver.image.source }}":true}}'
              register: localsocketproxyimage
    - processor:
        id: process.conditional.local.socketproxy.image
        as: not_local_socketproxy_image
        data: '{{ localsocketproxyimage }}'
        filter: '{{ ne 1 (len $localsocketproxyimage) }}'
        depends_on:
          - get.local.socketproxy.image
    - requests:
        if: '{{ not_local_socketproxy_image }}'
        endpoint: /images/create
        method: POST
        depends_on:
          - process.conditional.local.socketproxy.image
        with:
          - body:
              id: '{{ $dependencies.images.pull.socketproxy }}'
              query:
                fromImage: '{{ $socketproxy.linuxserver.image.source }}'
                tag: '{{ $socketproxy.linuxserver.tag }}'

...
