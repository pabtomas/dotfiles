---

# TODO:
# - variabilize ids
# - variabilize depends_on
# - use JQ filter instead of Golang template

rule:
  id: '{{ $rules.down }}'
  run:
    - requests:
        endpoint: /networks
        method: GET
        with:
          - body:
              id: get.networks
              query:
                filters: '{"label":{"navy":{{ $project.id }}}}'
              errexit: false
              register: listed_networks
    - processor:
        id: process.remove.networks
        as: networks_to_remove
        data: '{{ listed_networks }}'
        filter: '{{ $array := "" }}{{ range $listed_networks }}{{ $array = print $array "{\"path\":{\"id\":\"" .Name "\"}}," }}{{ end }}{{ print "[" $array "]" | data.YAMLArray }}'
        depends_on:
          - get.networks
    - requests:
        endpoint: /networks/{id}
        method: DELETE
        with: '{{ networks_to_remove }}'
        depends_on:
          - process.remove.networks

...
