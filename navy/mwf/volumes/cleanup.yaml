---

# TODO:
# - variabilize ids
# - variabilize depends_on
# - use JQ filter instead of Golang template

rule:
  id: '{{ $rules.down }}'
  run:
    - register:
        id: get.volumes
        as: listed_volumes
        endpoint: /volumes
        method: GET
        query:
          filters: '{"label":{"navy":{{ $project.id }}}}'
        errexit: false
    - processor:
        id: process.remove.volumes
        as: volumes_to_remove
        data: '{{ listed_volumes }}'
        filter: '{{ $array := "" }}{{ range $listed_volumes }}{{ $array = print $array "{\"path\":{\"name\":\"" .Name "\"},\"query\":{\"force\":true}}," }}{{ end }}{{ print "[" $array "]" | data.YAMLArray }}'
        depends_on:
          - get.volumes
    - loop:
        endpoint: /volumes/{name}
        method: DELETE
        from: '{{ volumes_to_remove }}'
        depends_on:
          - process.remove.volumes

...
