---

# TODO:
# - variabilize ids
# - variabilize depends_on
# - use JQ filter instead of Golang template

rule:
  id: '{{ $rules.down }}'
  run:
    - requests:
        endpoint: /volumes
        method: GET
        with:
          - body:
              id: get.volumes
              query:
                filters: '{"label":{"navy":{{ $project.id }}}}'
              register: listed_volumes
              errexit: false
    - processor:
        id: process.remove.volumes
        as: volumes_to_remove
        data: '{{ listed_volumes }}'
        filter: '{{ $array := "" }}{{ range $listed_volumes }}{{ $array = print $array "{\"path\":{\"name\":\"" .Name "\"},\"query\":{\"force\":true}}," }}{{ end }}{{ print "[" $array "]" | data.YAMLArray }}'
        depends_on:
          - get.volumes
    - requests:
        endpoint: /volumes/{name}
        method: DELETE
        with: '{{ volumes_to_remove }}'
        depends_on:
          - process.remove.volumes

...
