---

# TODO:
# - variabilize ids
# - variabilize depends_on
# - use JQ filter instead of Golang template

rule:
  id: '{{ $rules.down }}'
  run:
    - requests:
        endpoint: /containers/json
        method: GET
        with:
          - body:
              id: get.containers
              query:
                filters: '{"label":{"navy":{{ $project.id }}}}'
              errexit: false
              register: running_containers
    - processor:
        id: process.stop.running_containers
        as: containers_to_stop
        data: '{{ running_containers }}'
        filter: '{{ $array := "" }}{{ range $running_containers }}{{ $array = print $array "{\"id\":\"containers.stop." .Id "\",\"path\":{\"id\":\"" .Id "\"},\"query\":{\"t\":0}," }}{{ end }}{{ print "[" $array "]" | data.YAMLArray }}'
        depends_on:
          - get.containers
    - processor:
        id: process.remove.containers
        as: containers_to_remove
        data: '{{ running_containers }}'
        filter: '{{ $array := "" }}{{ range $running_containers }}{{ $array = print $array "{\"depends_on\":[\"containers.stop." .Id "\"],\"path\":{\"id\":\"" .Id "\"},\"query\":{\"force\":true}}," }}{{ end }}{{ print "[" $array "]" | data.YAMLArray }}'
        depends_on:
          - get.containers
    - requests:
        endpoint: /containers/{id}/stop
        method: POST
        with: '{{ containers_to_stop }}'
        depends_on:
          - process.stop.containers
    - requests:
        endpoint: /containers/{id}
        method: DELETE
        with: '{{ containers_to_remove }}'
        depends_on:
          - process.remove.containers

...
