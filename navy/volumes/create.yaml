---

run:
  - endpoint: /volumes
    method: GET
    register:
      as:
        id: registervolumes
        scope: volumes.create.*
  - if: '{{ $volumes := coll.Slice }}{{ range $registervolumes }}{{ $volumes = $volumes | append .Name }}{{ end }}
      {{ or (not (has $net (datasource "datasources/volumes.yaml").carpenter_relay_xserver_socket_volume))
            (not (has $net (datasource "datasources/volumes.yaml").listener_opt_data_volume))
            (not (has $net (datasource "datasources/volumes.yaml").listener_opt_scripts_volume))
            (not (has $net (datasource "datasources/volumes.yaml").listener_var_log_volume))
            (not (has $net (datasource "datasources/volumes.yaml").mywhalefleet_volume))
            (not (has $net (datasource "datasources/volumes.yaml").proxy_etc_nginx_volume))
            (not (has $net (datasource "datasources/volumes.yaml").proxy_opt_scripts_volume))
            (not (has $net (datasource "datasources/volumes.yaml").proxy_var_log_nginx_volume))
            (not (has $net (datasource "datasources/volumes.yaml").registry_volume))
            (not (has $net (datasource "datasources/volumes.yaml").relay_var_log_volume))
            (not (has $net (datasource "datasources/volumes.yaml").safedeposit_volume))
            (not (has $net (datasource "datasources/volumes.yaml").spaceporn_relay_xserver_socket_volume))
            (not (has $net (datasource "datasources/volumes.yaml").ssh_volume))
            (not (has $net (datasource "datasources/volumes.yaml").spaceporn_volume))
            (not (has $net (datasource "datasources/volumes.yaml").theme_volume))
            (not (has $net (datasource "datasources/volumes.yaml").xserver_etc_nginx_volume))
            (not (has $net (datasource "datasources/volumes.yaml").xserver_opt_scripts_volume))
            (not (has $net (datasource "datasources/volumes.yaml").xserver_var_log_nginx_volume)) }}'
    endpoint: /volumes/create
    method: POST
    loop:
      - id: volumes.create.virtual
        virtual: true
        query:
          Labels:
            navy: true
        depends_on:
          - volumes.json
      - id: volumes.create.${CARPENTER_RELAY_XSERVER_SOCKET_VOLUME}
        query:
          Name: ${CARPENTER_RELAY_XSERVER_SOCKET_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${LISTENER_OPT_DATA_VOLUME}
        query:
          Name: ${LISTENER_OPT_DATA_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${LISTENER_OPT_SCRIPTS_VOLUME}
        query:
          Name: ${LISTENER_OPT_SCRIPTS_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${LISTENER_VAR_LOG_VOLUME}
        query:
          Name: ${LISTENER_VAR_LOG_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${MYWHALEFLEET_VOLUME}
        query:
          Name: ${MYWHALEFLEET_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${PROXY_ETC_NGINX_VOLUME}
        query:
          Name: ${PROXY_ETC_NGINX_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${PROXY_OPT_SCRIPTS_VOLUME}
        query:
          Name: ${PROXY_OPT_SCRIPTS_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${PROXY_VAR_LOG_NGINX_VOLUME}
        query:
          Name: ${PROXY_VAR_LOG_NGINX_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${REGISTRY_VOLUME}
        query:
          Name: ${REGISTRY_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${RELAY_VAR_LOG_VOLUME}
        query:
          Name: ${RELAY_VAR_LOG_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${SAFEDEPOSIT_VOLUME}
        query:
          Name: ${SAFEDEPOSIT_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${SPACEPORN_RELAY_XSERVER_SOCKET_VOLUME}
        query:
          Name: ${SPACEPORN_RELAY_XSERVER_SOCKET_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${SSH_VOLUME}
        query:
          Name: ${SSH_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${SPACEPORN_VOLUME}
        query:
          Name: ${SPACEPORN_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${THEME_VOLUME}
        query:
          Name: ${THEME_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${XSERVER_ETC_NGINX_VOLUME}
        query:
          Name: ${XSERVER_ETC_NGINX_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${XSERVER_OPT_SCRIPTS_VOLUME}
        query:
          Name: ${XSERVER_OPT_SCRIPTS_VOLUME}
        extends:
          - volumes.create.virtual
      - id: volumes.create.${XSERVER_VAR_LOG_NGINX_VOLUME}
        query:
          Name: ${XSERVER_VAR_LOG_NGINX_VOLUME}
        extends:
          - volumes.create.virtual

...
