---

run:
  - endpoint: /build
    method: POST
    loop:
      - id: images.build.virtual.base
        virtual: true
        query:
          nocache: false
          buildargs:
            HTTP_PROXY: ${http_proxy:-${HTTP_PROXY:-}}
            HTTPS_PROXY: ${https_proxy:-${HTTPS_PROXY:-}}
          dockerfile: Dockerfile
      - id: images.build.virtual.entrypoint
        virtual: true
        query:
          buildargs:
            CHECK_ENTRYPOINT_PATH: '{{ $entrypoint.path.check.sh }}'
            CHECK_ENTRYPOINTD_PATH: '{{ $entrypoint.path.check.d }}'
            ENTRYPOINT_PATH: '{{ $entrypoint.path.entrypoint.sh }}'
            ENTRYPOINTD_PATH: '{{ $entrypoint.path.entrypoint.d }}'
        context: '{{ $all.path.dockerfiles }}'/${ENTRYPOINT_ID}
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.alpine.entrypoint
        virtual: true
        query:
          buildargs:
            ENTRYPOINT_LAYER_IMG: '{{ $entrypointalpine.image }}{{ $all.sep.tag }}{{ $all.owner.tag }}'
        depends_on:
          - images.build.alpine.entrypoint
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.bash
        virtual: true
        query:
          buildargs:
            BASH_LAYER_IMG: '{{ $bash.image.layer }}{{ $all.sep.tag }}{{ $all.owner.tag }}'
        depends_on:
          - images.build.bash
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.workspaces
        virtual: true
        query:
          buildargs:
            WORKSPACES_LAYER_IMG: '{{ $workspaces.image.layer }}{{ $all.sep.tag }}{{ $all.owner.tag }}'
        depends_on:
          - images.build.workspaces
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.sshd
        virtual: true
        query:
          buildargs:
            SSHD_LAYER_IMG: '{{ $sshd.image }}{{ $all.sep.tag }}{{ $all.owner.tag }}'
        depends_on:
          - images.build.sshd
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.git
        virtual: true
        query:
          buildargs:
            GIT_LAYER_IMG: '{{ $git.yaml").image }}{{ $all.sep.tag }}{{ $all.owner.tag }}'
        depends_on:
          - images.build.git
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.nginx
        virtual: true
        query:
          buildargs:
            NGINX_LAYER_IMG: '{{ $nginx.image }}{{ $all.sep.tag }}{{ $all.owner.tag }}'
        depends_on:
          - images.build.nginx
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.relay
        virtual: true
        query:
          buildargs:
            ENTRYPOINTD_PATH: '{{ $entrypoint.path.entrypoint.d }}'
            SOCAT_LAYER_IMG: '{{ $socat.image }}{{ $all.sep.tag }}{{ $all.owner.tag }}'
            TMP_XSERVER_SOCKETS_PATH: '{{ $xserver.path.sockets }}'
            XSERVER_IP: '{{ $xserver.ip }}'
            XSERVER_PORT: '{{ $xserver.port }}'
        context: '{{ $all.path.dockerfiles }}'/${RELAY_ID}
        depends_on:
          - images.build.socat
        extends:
          - images.build.virtual.base

...
