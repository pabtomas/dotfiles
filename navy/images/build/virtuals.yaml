---

run:
  - endpoint: /build
    method: POST
    loop:
      - id: images.build.virtual.base
        virtual: true
        query:
          nocache: false
          buildargs:
            HTTP_PROXY: ${http_proxy:-${HTTP_PROXY:-}}
            HTTPS_PROXY: ${https_proxy:-${HTTPS_PROXY:-}}
          dockerfile: Dockerfile
      - id: images.build.virtual.entrypoint
        virtual: true
        query:
          buildargs:
            CHECK_ENTRYPOINT_PATH: {{ (datasource "datasources/entrypoint.yaml").path.check.sh }}
            CHECK_ENTRYPOINTD_PATH: {{ (datasource "datasources/entrypoint.yaml").path.check.d }}
            ENTRYPOINT_PATH: {{ (datasource "datasources/entrypoint.yaml").path.entrypoint.sh }}
            ENTRYPOINTD_PATH: {{ (datasource "datasources/entrypoint.yaml").path.entrypoint.d }}
        context: {{ (datasource "datasources/all.yaml").path.dockerfiles }}/${ENTRYPOINT_ID}
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.alpine.entrypoint
        virtual: true
        query:
          buildargs:
            ENTRYPOINT_LAYER_IMG: {{ (datasource "datasources/entrypoint/alpine.yaml").image }}{{ (datasource "datasources/all.yaml").sep.tag }}{{ (datasource "datasources/all.yaml").owner.tag }}
        depends_on:
          - images.build.alpine.entrypoint
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.bash
        virtual: true
        query:
          buildargs:
            BASH_LAYER_IMG: {{ (datasource "datasources/bash.yaml").image.layer }}{{ (datasource "datasources/all.yaml").sep.tag }}{{ (datasource "datasources/all.yaml").owner.tag }}
        depends_on:
          - images.build.bash
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.workspaces
        virtual: true
        query:
          buildargs:
            WORKSPACES_LAYER_IMG: {{ (datasource "datasources/workspaces.yaml").image.layer }}{{ (datasource "datasources/all.yaml").sep.tag }}{{ (datasource "datasources/all.yaml").owner.tag }}
        depends_on:
          - images.build.workspaces
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.sshd
        virtual: true
        query:
          buildargs:
            SSHD_LAYER_IMG: {{ (datasource "datasources/sshd.yaml").image }}{{ (datasource "datasources/all.yaml").sep.tag }}{{ (datasource "datasources/all.yaml").owner.tag }}
        depends_on:
          - images.build.sshd
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.git
        virtual: true
        query:
          buildargs:
            GIT_LAYER_IMG: {{ (datasource "datasources/git.yaml").image }}{{ (datasource "datasources/all.yaml").sep.tag }}{{ (datasource "datasources/all.yaml").owner.tag }}
        depends_on:
          - images.build.git
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.nginx
        virtual: true
        query:
          buildargs:
            NGINX_LAYER_IMG: {{ (datasource "datasources/nginx.yaml").image }}{{ (datasource "datasources/all.yaml").sep.tag }}{{ (datasource "datasources/all.yaml").owner.tag }}
        depends_on:
          - images.build.nginx
        extends:
          - images.build.virtual.base
      - id: images.build.virtual.relay
        virtual: true
        query:
          buildargs:
            ENTRYPOINTD_PATH: {{ (datasource "datasources/entrypoint.yaml").path.entrypoint.d }}
            SOCAT_LAYER_IMG: {{ (datasource "datasources/socat.yaml").image }}{{ (datasource "datasources/all.yaml").sep.tag }}{{ (datasource "datasources/all.yaml").owner.tag }}
            TMP_XSERVER_SOCKETS_PATH: {{ (datasource "datasources/xserver.yaml").path.sockets }}
            XSERVER_IP: {{ (datasource "datasources/xserver.yaml").ip }}
            XSERVER_PORT: {{ (datasource "datasources/xserver.yaml").port }}
        context: {{ (datasource "datasources/all.yaml").path.dockerfiles }}/${RELAY_ID}
        depends_on:
          - images.build.socat
        extends:
          - images.build.virtual.base

...
