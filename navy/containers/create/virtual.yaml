---

requests:
  - endpoint: /containers/create
    method: POST
    loop:
      - id: containers.create.virtual.docker
        virtual: true
        query:
          Image: ${_DOCKER_LAYER_IMG}
          NetworkingConfig:
            EndpointsConfig:
              ${_DOCKER_NET}: {}
              ${PROXIFIED_DOCKER_SOCKET_NET}: {}
        depends_on:
          - build.docker
          - networks.create.${_DOCKER_NET}
          - networks.create.${PROXIFIED_DOCKER_SOCKET_NET}
      - id: containers.create.virtual.isolated
        virtual: true
        query:
          HostConfig:
            NetworkMode: none
      - id: containers.create.virtual.gpu
        virtual: true
        query:
          Image: ${GPU_LAYER_IMG}
          Devices:
            - PathOnHost: ${GPU_PATH}
              PathInContainer: ${GPU_PATH}
              CgroupPermissions: rwm
            - PathOnHost: ${VGA_PATH}
              PathInContainer: ${VGA_PATH}
              CgroupPermissions: rwm
          GroupAdd:
            - render
            - video
        depends_on:
          - build.gpu
      - id: containers.create.virtual.man
        virtual: true
        query:
          Image: ${MAN_LAYER_IMG}
        depends_on:
          - build.man
        extends:
          - containers.create.virtual.sshd
      - id: containers.create.virtual.pass
        virtual: true
        query:
          Image: ${PASS_LAYER_IMG}
        depends_on:
          - build.pass
        extends:
          - containers.create.virtual.sshd
      - id: containers.create.virtual.registry
        virtual: true
        query:
          Image: ${REGISTRY_LAYER_IMG}
          Env:
            - REGISTRY_LOG_ACCESSLOG_DISABLED=false
            - REGISTRY_LOG_FORMATTER=text
            - REGISTRY_LOG_LEVEL=info
            - REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=${DATA_PATH}
          HostConfig:
            Binds:
              - ${REGISTRY_VOLUME}:${DATA_PATH}:rw
            ReadonlyRootfs: true
          NetworkingConfig:
            EndpointsConfig:
              ${_DOCKER_NET}: {}
        depends_on:
          - build.registry
          - networks.create.${_DOCKER_NET}
          - volumes.create.${REGISTRY_VOLUME}
      - id: containers.create.virtual.sshd
        virtual: true
        query:
          Image: ${SSHD_LAYER_IMG}
          ExposedPorts:
            - ${SSH_PORT}/tcp
          HostConfig:
            Binds:
              - ${SSH_VOLUME}:${SSH_ROOT_PATH}:ro
              - ${THEME_VOLUME}:${BASH_THEME_PATH}:ro
          NetworkingConfig:
            EndpointsConfig:
              ${JUMP_AREA_NET}: {}
        depends_on:
          - build.sshd
          - networks.create.${JUMP_AREA_NET}
          - volume.create.${SSH_VOLUME}
          - volume.create.${THEME_VOLUME}
      - id: containers.create.virtual.shell
        virtual: true
        query:
          Image: ${SHELL_LAYER_IMG}
        depends_on:
          - build.shell
        extends:
          - containers.create.virtual.sshd
      - id: containers.create.virtual.vim
        virtual: true
        query:
          Image: ${VIM_LAYER_IMG}
        depends_on:
          - build.vim
        extends:
          - containers.create.virtual.sshd
      - id: containers.create.virtual.zig
        virtual: true
        query:
          Image: ${ZIG_LAYER_IMG}
        depends_on:
          - build.zig
        extends:
          - containers.create.virtual.sshd

...
