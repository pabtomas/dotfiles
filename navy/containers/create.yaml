---

include:
  - create/virtual.yaml

requests:
  - endpoint: /containers/create
    method: POST
    loop:
      - id: containers.create.builder
        query:
          name: ${BUILDER_HOST}
          Hostname: ${BUILDER_HOST}
          Image: ${BUILDER_IMG}
          Cmd:
            - --addr
            - tcp://0.0.0.0:${BUILDER_PORT}
            - --config
            - ${_BUILDKIT_CONF_PATH}
            - --oci-worker-no-process-sandbox
          ExposedPorts:
            - ${BUILDER_PORT}/tcp
          HostConfig:
            SecurityOpt:
              - apparmor:unconfined
              - seccomp:unconfined
          NetworkConfig:
            EndpointsConfig:
              ${_DOCKER_NET}:
                IPv4Address: ${BUILDER_IP}
        depends_on:
          - build.builder
          - networks.create.${_DOCKER_NET}
      - id: containers.create.carpenter.relay
          name: ${CARPENTER_RELAY_HOST}
          Hostname: ${CARPENTER_RELAY_HOST}
          Image: ${CARPENTER_RELAY_IMG}
          HostConfig:
            Binds:
              - ${CARPENTER_RELAY_XSERVER_SOCKET_VOLUME}:${TMP_XSERVER_SOCKETS_PATH}:rw
              - ${RELAY_VAR_LOG_VOLUME}:${VAR_LOG_PATH}:rw
            ReadonlyRootfs: true
          NetworkConfig:
            EndpointsConfig:
              ${PROXIFIED_XSERVER_SOCKET_NET}:
                IPv4Address: ${CARPENTER_RELAY_IP}
        depends_on:
          - build.carpenter.relay
          - networks.create.${PROXIFIED_XSERVER_SOCKET_NET}
          - volumes.create.${CARPENTER_RELAY_XSERVER_SOCKET_VOLUME}
          - volumes.create.${RELAY_VAR_LOG_VOLUME}
      - id: containers.create.carpenter.runner
          name: ${CARPENTER_RUNNER_HOST}
          Hostname: ${CARPENTER_RUNNER_HOST}
          Image: ${CARPENTER_RUNNER_IMG}
          HostConfig:
            Binds:
              - ${CARPENTER_RELAY_XSERVER_SOCKET_VOLUME}:${TMP_XSERVER_SOCKETS_PATH}:ro
        depends_on:
          - build.carpenter.runner
          - volumes.create.${CARPENTER_RELAY_XSERVER_SOCKET_VOLUME}
        extends:
          - containers.create.virtual.isolated
      - id: containers.create.controller
          name: ${CONTROLLER_HOST}
          Hostname: ${CONTROLLER_HOST}
          HostConfig:
            Binds:
              - ${MYWHALEFLEET_VOLUME}:${MYWHALEFLEET_PATH}:rw
          NetworkConfig:
            EndpointsConfig:
              ${_DOCKER_NET}:
                IPv4Address: ${CLIENT_IP}
              ${PROXIFIED_DOCKER_SOCKET_NET}:
                IPv4Address: ${CONTROLLER_IP}
        depends_on:
          - volumes.create.${MYWHALEFLEET_VOLUME}
        extends:
          - containers.create.virtual.docker
      - id: containers.create.editor
          name: ${EDITOR_HOST}
          Hostname: ${EDITOR_HOST}
          HostConfig:
            Binds:
              - ${MYWHALEFLEET_VOLUME}:${MYWHALEFLEET_PATH}:rw
              - ${SPACEPORN_VOLUME}:${SPACEPORN_PATH}:rw
        depends_on:
          - volumes.create.${MYWHALEFLEET_VOLUME}
          - volumes.create.${SPACEPORN_VOLUME}
        extends:
          - containers.create.virtual.vim

...
